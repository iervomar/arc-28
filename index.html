<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Espresso Quest - A Birthday Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #3e2723 0%, #5d4037 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 100vh;
            max-height: 800px;
            background: white;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
        }

        /* Gift Image Background */
        #reward-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-image: linear-gradient(rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.85)), url('nanopresso.jpg');
            transition: filter 1s ease;
            filter: blur(35px);
        }

        /* Main UI Layer */
        #ui-layer {
            position: relative;
            z-index: 5;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 30px 20px;
        }

        /* Header Section */
        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .header p {
            font-size: 1rem;
            color: #666;
            font-weight: 500;
        }

        /* Game Area */
        #game-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 300px;
            margin: 20px 0;
        }

        #game-svg {
            width: 85%;
            height: auto;
            max-height: 280px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        /* Progress Section */
        .progress-section {
            width: 100%;
            margin-bottom: 20px;
        }

        .progress-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
            text-align: center;
            font-weight: 500;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #d4a373, #e8b88a);
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Buttons */
        .button-section {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn {
            padding: 12px 28px;
            background: #333;
            border: none;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            background: #555;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .reset-btn {
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.05);
            color: #888;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
            font-size: 0.85rem;
            flex: 1;
        }

        .reset-btn:hover {
            background: rgba(0, 0, 0, 0.08);
            color: #666;
        }

        /* Overlay Screens */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            background: rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            backdrop-filter: blur(2px);
        }

        #overlay.hidden {
            display: none;
        }

        .overlay-content h2 {
            font-size: 2rem;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .overlay-content p {
            font-size: 1rem;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* Victory Screen */
        #victory-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 200;
            background: white;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 20px;
        }

        #victory-screen.show {
            display: flex;
        }

        #victory-image {
            width: 90%;
            height: auto;
            max-height: 70%;
            object-fit: contain;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        #victory-text {
            text-align: center;
            margin-bottom: 20px;
        }

        #victory-text h1 {
            font-size: 2rem;
            color: #333;
            margin-bottom: 10px;
        }

        #victory-text p {
            font-size: 1rem;
            color: #666;
        }

        /* Confetti */
        .confetti {
            position: fixed;
            pointer-events: none;
            z-index: 150;
            font-size: 2rem;
            animation: confetti-fall 3s ease-out forwards;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        @media (max-height: 700px) {
            #ui-layer {
                padding: 15px 10px;
            }

            .header h1 {
                font-size: 1.1rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            #game-svg {
                max-height: 200px;
            }

            #game-area {
                min-height: 200px;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Gift Image Background -->
        <div id="reward-bg"></div>

        <!-- Victory Screen -->
        <div id="victory-screen">
            <div id="victory-text">
                <h1>üéâ Perfectly Brewed! ‚òï</h1>
                <p>You've mastered the art of espresso!</p>
            </div>
            <img id="victory-image" src="nanopresso.jpg" alt="Your gift!">
            <div style="display: flex; gap: 10px; width: 90%; max-width: 300px;">
                <button class="btn" onclick="watchYouTube()" style="flex: 1;">WATCH THE VIDEO</button>
                <button class="btn" onclick="resetGame()" style="flex: 1;">PLAY AGAIN</button>
            </div>
        </div>

        <!-- Main UI Layer -->
        <div id="ui-layer">
            <div class="header">
                <h1 id="level-title">The Espresso Quest</h1>
                <p id="level-instruction"></p>
            </div>

            <div id="game-area">
                <svg viewBox="0 0 200 200" id="game-svg" preserveAspectRatio="xMidYMid meet"></svg>
            </div>

            <div class="progress-section">
                <div class="progress-label" id="progress-label">Ready to begin</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>

            <div class="button-section">
                <button class="btn" id="main-btn" onclick="handleMainButton()" style="flex: 1;">START QUEST</button>
                <button class="reset-btn" onclick="resetGame()">RESET</button>
            </div>
        </div>

        <!-- Overlay for transitions -->
        <div id="overlay" class="hidden">
            <div class="overlay-content">
                <h2 id="overlay-title"></h2>
                <p id="overlay-subtitle"></p>
                <button class="btn" id="continue-btn" onclick="continueToNextLevel()">CONTINUE</button>
            </div>
        </div>
    </div>

    <script>
        // Game State
        const gameState = {
            currentLevel: parseInt(localStorage.getItem('espresso_level')) || 0,
            progress: 0,
            isTransitioning: true,
            canInteract: false
        };

        // Level 5 handler references for cleanup
        let level5Handlers = {
            mouseDown: null,
            mouseMove: null,
            mouseUp: null
        };

        // Configuration
        const config = {
            levels: 5,
            blurSteps: [35, 25, 18, 12, 6, 0],
            levelNames: ['', 'The Base', 'The Coffee', 'Assembly', 'Extraction', 'The Pour'],
            instructions: [
                '',
                'Fill the base with water',
                'Fill the funnel with coffee powder',
                'Screw the moka closed',
                'Heat up the moka',
                'Pour the coffee in the cup'
            ]
        };

        // DOM Elements
        const elements = {
            container: document.getElementById('game-container'),
            uiLayer: document.getElementById('ui-layer'),
            overlay: document.getElementById('overlay'),
            victoryScreen: document.getElementById('victory-screen'),
            rewardBg: document.getElementById('reward-bg'),
            gameArea: document.getElementById('game-area'),
            svg: document.getElementById('game-svg'),
            levelTitle: document.getElementById('level-title'),
            levelInstruction: document.getElementById('level-instruction'),
            mainBtn: document.getElementById('main-btn'),
            resetBtn: document.querySelector('.reset-btn'),
            continueBtn: document.getElementById('continue-btn'),
            progressFill: document.getElementById('progress-fill'),
            progressLabel: document.getElementById('progress-label')
        };

        // Initialize game
        function initGame() {
            elements.rewardBg.style.display = 'none';
            updateBlur();
            showTransitionScreen();
        }

        // Update blur effect
        function updateBlur() {
            const blurAmount = config.blurSteps[gameState.currentLevel] || 0;
            elements.rewardBg.style.filter = `blur(${blurAmount}px)`;
        }

        // Show transition screen
        function showTransitionScreen() {
            if (gameState.currentLevel === config.levels) {
                elements.overlay.classList.add('hidden');
                elements.uiLayer.style.display = 'flex';
                showVictoryScreen();
                return;
            }

            // Hide the game UI and show the transition overlay with background
            elements.uiLayer.style.display = 'none';
            elements.overlay.classList.remove('hidden');

            if (gameState.currentLevel === 0) {
                document.getElementById('overlay-title').innerText = 'üéÅ The Espresso Quest';
                document.getElementById('overlay-subtitle').innerText = 'A birthday adventure to master the perfect brew';
                document.getElementById('continue-btn').innerText = 'START QUEST';
                elements.mainBtn.style.display = 'none';
                elements.resetBtn.style.display = 'block';
            } else if (gameState.currentLevel < config.levels) {
                const blurAmount = config.blurSteps[gameState.currentLevel];
                document.getElementById('overlay-title').innerText = `‚úì Level ${gameState.currentLevel} Complete!`;
                const progress = Math.round((gameState.currentLevel / config.levels) * 100);
                document.getElementById('overlay-subtitle').innerText = `${progress}% of the way there\n\nReady for the next step?`;
                document.getElementById('continue-btn').innerText = 'CONTINUE';

                elements.rewardBg.style.display = 'block';
                elements.rewardBg.style.filter = `blur(${blurAmount}px)`;
                elements.mainBtn.style.display = 'none';
                elements.resetBtn.style.display = 'block';
            }

            updateUI();
        }

        // Continue to next level
        function continueToNextLevel() {
            if (gameState.currentLevel === 0) {
                gameState.currentLevel = 1;
            } else if (gameState.currentLevel < config.levels) {
                gameState.currentLevel++;
            }

            if (gameState.currentLevel > config.levels) {
                showVictoryScreen();
            } else {
                startLevel();
            }
        }

        // Handle main button click
        function handleMainButton() {
            if (gameState.isTransitioning) {
                continueToNextLevel();
            }
        }

        // Start current level
        function startLevel() {
            gameState.isTransitioning = false;
            gameState.progress = 0;
            gameState.canInteract = true;
            elements.overlay.classList.add('hidden');
            elements.uiLayer.style.display = 'flex';
            elements.svg.innerHTML = '';
            
            // Hide background image and show white background during gameplay
            elements.rewardBg.style.display = 'none';
            
            // Hide main button and show reset button during gameplay
            elements.mainBtn.style.display = 'none';
            elements.resetBtn.style.display = 'block';
            
            updateUI();

            // Clear old event listeners
            document.onmousemove = null;
            document.ontouchmove = null;
            document.onmousedown = null;
            document.ontouchstart = null;
            document.onmouseup = null;
            document.ontouchend = null;

            if (gameState.currentLevel === 1) setupLevel1();
            else if (gameState.currentLevel === 2) setupLevel2();
            else if (gameState.currentLevel === 3) setupLevel3();
            else if (gameState.currentLevel === 4) setupLevel4();
            else if (gameState.currentLevel === 5) setupLevel5();
        }

        // Update UI
        function updateUI() {
            elements.levelTitle.innerText = gameState.currentLevel > 0 
                ? `Level ${gameState.currentLevel}: ${config.levelNames[gameState.currentLevel]}`
                : '';
            elements.levelInstruction.innerText = config.instructions[gameState.currentLevel] || '';
            elements.progressFill.style.width = Math.min(gameState.progress * 100, 100) + '%';
            elements.progressLabel.innerText = `Progress: ${Math.round(gameState.progress * 100)}%`;
        }

        // Level 1: Fill the base with water (TAP)
        function setupLevel1() {
            elements.svg.innerHTML = `
                <svg viewBox="0 0 204 148" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                    <!-- Base moka pot -->
                    <g transform="translate(25,150) scale(0.08,-0.08)" fill="#000000" stroke="none">
                        <path d="M383 1448 c-6 -18 -32 -82 -57 -143 -88 -213 -138 -463 -156 -778 l-12 -198 23 -33 c30 -45 90 -79 201 -115 116 -39 208 -56 372 -72 161 -15 522 -6 666 16 131 20 311 75 370 113 86 55 83 47 83 265 -2 412 -58 665 -210 944 -19 35 -33 42 -33 18 0 -30 -111 -69 -280 -97 -121 -20 -551 -17 -683 5 -148 25 -270 70 -259 94 2 4 0 9 -5 10 -4 2 -13 -12 -20 -29z m42 -27 c13 -22 245 -81 318 -81 15 0 27 -1 27 -3 0 -1 -4 -18 -10 -37 -16 -54 -48 -243 -65 -375 -26 -209 -35 -358 -35 -576 l-1 -211 -25 6 c-14 4 -67 15 -117 26 -149 31 -248 70 -299 118 -27 25 -28 29 -28 136 0 314 62 649 167 899 43 102 54 119 68 98z m1269 -83 c107 -224 156 -492 156 -848 0 -196 -2 -200 -103 -249 -52 -26 -238 -81 -272 -81 -6 0 -9 31 -6 81 9 209 -32 679 -85 966 -13 73 -24 135 -24 138 0 3 9 5 21 5 35 0 180 40 218 60 20 11 39 19 43 20 4 0 28 -42 52 -92z m-335 -118 c55 -300 81 -579 81 -866 l0 -201 -30 -6 c-130 -26 -597 -33 -704 -10 l-29 6 6 261 c6 259 13 360 43 571 15 108 51 315 59 345 4 13 44 15 279 15 l273 0 22 -115z"/>
                    </g>
                    <!-- Rising water square -->
                    <rect id="water" x="40" y="140" width="135" height="0" fill="#a2d2ff" opacity="0.8"/>
                </svg>
            `;

            elements.svg.onclick = (e) => {
                if (!gameState.canInteract || gameState.isTransitioning) return;
                gameState.progress = Math.min(gameState.progress + 0.12, 1);
                
                // Rise from bottom: calculate height and y position
                const maxHeight = 100;
                const waterHeight = gameState.progress * maxHeight;
                const waterY = 140 - waterHeight;
                
                document.getElementById('water').setAttribute('height', waterHeight);
                document.getElementById('water').setAttribute('y', waterY);

                updateUI();
                
                if (gameState.progress >= 0.95 && !gameState.isTransitioning) completeLevel();
            };
        }

        // Level 2: Fill funnel with coffee (SHAKE/MOUSE MOVEMENT)
        function setupLevel2() {
            elements.svg.innerHTML = `
                <svg viewBox="0 0 132 183" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                    <!-- Funnel -->
                    <g transform="translate(10,150) scale(0.08,-0.08)" fill="#000000" stroke="none">
                        <path d="M440 1569 c-148 -9 -282 -32 -317 -55 -23 -14 -23 -16 -23 -258 0 -298 -7 -281 143 -326 128 -39 214 -78 238 -109 17 -22 19 -44 19 -279 l0 -254 40 -40 c38 -39 42 -40 91 -36 40 4 58 12 82 37 l32 31 3 258 c3 249 4 258 25 280 33 36 80 57 207 91 139 38 162 47 189 72 20 19 21 29 21 269 l0 250 -24 15 c-36 24 -165 45 -346 55 -181 11 -186 11 -380 -1z m612 -44 c48 -9 95 -23 104 -30 15 -11 12 -14 -32 -28 -167 -56 -692 -61 -916 -11 -61 14 -88 28 -76 39 10 10 130 36 208 44 138 16 609 6 712 -14z m-782 -106 c52 -10 166 -14 375 -14 299 0 394 8 485 39 l40 14 0 -223 0 -224 -25 -19 c-13 -11 -77 -34 -142 -51 -139 -38 -208 -68 -245 -106 l-28 -28 0 -244 c0 -268 -4 -289 -60 -318 -43 -22 -76 -18 -112 14 l-33 29 -3 249 c-1 136 -4 258 -7 270 -9 40 -87 88 -197 122 -57 18 -122 41 -145 52 l-43 19 0 229 0 230 33 -13 c17 -8 66 -20 107 -27z"/>
                    </g>
                    <!-- Rising coffee square -->
                    <rect id="coffee" x="20" y="80" width="84" height="0" fill="#5d4037" opacity="0.8"/>
                </svg>
            `;

            let lastX = 0;
            let shakeCount = 0;

            // Shake detection for mobile only
            window.addEventListener('devicemotion', (e) => {
                if (!gameState.canInteract || gameState.isTransitioning) return;
                
                const acceleration = e.accelerationIncludingGravity;
                const x = acceleration.x || 0;
                const y = acceleration.y || 0;
                const z = acceleration.z || 0;
                
                // Calculate magnitude of acceleration
                const magnitude = Math.sqrt(x * x + y * y + z * z);
                
                // Detect shake (threshold around 15-20)
                if (magnitude > 15) {
                    shakeCount += (magnitude - 15) / 30;
                    gameState.progress = Math.min(shakeCount / 100, 1);
                    
                    // Rise from bottom
                    const maxHeight = 60;
                    const coffeeHeight = gameState.progress * maxHeight;
                    const coffeeY = 80 - coffeeHeight;
                    
                    document.getElementById('coffee').setAttribute('height', coffeeHeight);
                    document.getElementById('coffee').setAttribute('y', coffeeY);
                    
                    if (Math.random() > 0.6) {
                        createCoffeeParticle();
                    }
                    
                    updateUI();
                    
                    if (gameState.progress >= 0.95 && !gameState.isTransitioning) completeLevel();
                }
            }, true);
        }

        // Level 3: Screw the moka closed (HORIZONTAL SWIPE-BASED MIRRORING)
        function setupLevel3() {
            let isMirrored = false;
            let swipeCount = 0;

            function updateLevel3Display() {
                const scaleX = isMirrored ? -0.12 : 0.12;
                const positionX = isMirrored ? 340 : -25;
                
                elements.svg.innerHTML = `
                    <svg viewBox="0 0 300 440" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                        <!-- Full moka pot from provided Moka.svg - centered and mirrored with each swipe -->
                        <g transform="translate(${positionX},440) scale(${scaleX},-0.12)" fill="#000000" stroke="none">
                            <path d="M1618 3663 c7 -3 16 -2 19 1 4 3 -2 6 -13 5 -11 0 -14 -3 -6 -6z"/>
                            <path d="M1660 3651 c0 -6 4 -12 8 -15 5 -3 9 1 9 9 0 8 -4 15 -9 15 -4 0 -8 -4 -8 -9z"/>
                            <path d="M1310 3640 c-8 -5 -10 -10 -5 -10 6 0 17 5 25 10 8 5 11 10 5 10 -5 0 -17 -5 -25 -10z"/>
                            <path d="M1361 3628 c-45 -24 -47 -38 -17 -165 15 -66 35 -165 45 -221 l18 -102 -76 0 c-42 0 -181 -5 -310 -10 -128 -6 -330 -12 -448 -15 -118 -3 -223 -10 -233 -15 -36 -19 -240 -274 -246 -306 -12 -63 56 -334 187 -748 57 -180 83 -219 155 -231 21 -4 70 -13 109 -20 60 -12 74 -12 99 0 30 16 51 11 39 -8 -5 -8 -2 -8 9 0 8 7 19 9 23 5 5 -4 5 -1 1 6 -4 7 -11 10 -16 7 -17 -11 -20 15 -5 44 18 36 19 67 3 78 -7 4 -38 6 -68 5 -79 -4 -107 9 -130 60 -32 75 -136 725 -124 775 10 39 44 45 215 38 l156 -7 27 -182 c32 -208 88 -512 117 -636 16 -66 20 -116 19 -224 -1 -124 -3 -143 -24 -185 -106 -210 -176 -525 -196 -879 -11 -181 -10 -195 7 -224 37 -64 204 -132 413 -169 150 -27 522 -37 695 -19 283 29 483 90 561 171 l28 29 -1 193 c-2 351 -48 607 -148 825 -19 40 -43 85 -54 101 -18 25 -21 44 -21 148 0 137 9 223 51 538 l31 230 63 100 c100 161 194 302 207 312 7 5 32 15 55 22 24 6 47 20 53 31 39 73 -243 132 -730 151 -145 6 -274 9 -287 6 -19 -3 -22 0 -18 17 2 12 11 59 20 106 9 47 30 138 47 203 l31 119 -27 26 c-25 26 -31 27 -154 30 -88 2 -134 -1 -151 -10z m258 -17 c46 -13 48 -30 12 -173 -18 -73 -40 -178 -49 -234 l-17 -101 -66 1 -67 1 -7 55 c-8 68 -51 284 -71 363 -17 66 -10 83 34 90 44 7 205 6 231 -2z m579 -516 c3 -3 2 -8 -2 -12 -4 -5 -326 -8 -716 -8 -390 0 -712 3 -716 8 -4 4 -5 9 -2 12 3 3 148 8 323 12 290 6 318 5 327 -10 14 -26 168 -25 174 1 5 16 24 17 306 9 166 -4 304 -9 306 -12z m-1678 -104 c0 -54 3 -113 6 -130 l7 -31 -67 0 c-59 0 -70 -3 -93 -26 -25 -25 -25 -29 -19 -103 14 -168 103 -675 127 -723 28 -56 53 -68 136 -68 55 0 73 -3 73 -14 0 -25 -46 -81 -69 -84 -12 -2 -66 4 -119 14 -131 23 -137 30 -201 232 -114 359 -182 622 -183 704 0 45 5 54 77 142 42 52 96 115 119 140 l42 46 82 0 82 0 0 -99z m184 82 c11 -39 38 -244 33 -249 -3 -4 -47 -3 -96 1 l-91 7 0 53 c0 28 -3 86 -6 128 l-7 77 81 0 c68 0 81 -3 86 -17z m179 -13 c42 0 77 -2 77 -5 0 -29 132 -1190 136 -1197 8 -13 -19 -9 -90 12 l-66 21 -15 52 c-23 81 -61 267 -89 437 -25 149 -106 678 -106 691 0 4 17 3 38 -2 20 -5 72 -9 115 -9z m1591 -11 c84 -18 136 -40 136 -57 0 -5 -24 -16 -53 -25 -59 -19 -44 0 -222 -277 -78 -120 -87 -131 -81 -95 3 22 6 141 6 264 l0 224 63 -7 c34 -4 102 -16 151 -27z m-239 -231 c-6 -296 -7 -315 -46 -603 -16 -121 -33 -245 -37 -275 l-7 -55 -65 -21 c-36 -12 -87 -25 -114 -29 l-48 -7 6 79 c32 364 96 947 122 1111 l6 41 62 4 c33 2 75 4 93 5 l32 2 -4 -252z m-994 232 l229 0 0 -621 0 -622 -102 7 c-116 8 -239 24 -247 32 -3 2 -33 258 -67 567 -34 309 -65 582 -68 606 -5 36 -4 42 10 37 9 -3 119 -6 245 -6z m784 -12 c-12 -53 -76 -616 -102 -900 -20 -218 -32 -309 -41 -313 -7 -2 -97 -8 -200 -11 l-187 -7 0 621 0 622 255 3 c140 1 261 3 268 5 8 1 11 -6 7 -20z m-1030 -1187 c120 -45 231 -56 565 -56 334 1 467 14 553 55 l37 18 0 -124 0 -124 -38 -19 c-88 -45 -246 -70 -483 -78 -282 -9 -539 21 -655 78 l-41 20 1 124 c0 69 3 125 6 125 3 0 28 -8 55 -19z m-13 -278 c50 -23 155 -48 252 -59 47 -6 56 -10 51 -23 -13 -31 -45 -218 -65 -366 -31 -242 -40 -369 -41 -600 l-1 -217 -25 7 c-13 3 -66 14 -116 25 -118 25 -172 42 -235 74 -88 44 -92 53 -92 180 0 217 35 480 91 681 31 114 116 328 128 323 3 -2 27 -14 53 -25z m1221 -40 c109 -211 167 -511 167 -874 0 -163 -1 -168 -25 -197 -31 -37 -115 -74 -240 -106 -55 -14 -105 -26 -110 -26 -7 0 -9 28 -7 74 11 204 -31 687 -84 975 -14 73 -23 135 -22 136 2 1 42 10 90 19 48 10 108 29 135 41 26 13 51 24 54 24 4 1 22 -29 42 -66z m-320 -173 c55 -304 77 -544 77 -831 l0 -206 -30 -6 c-129 -26 -600 -33 -704 -10 l-29 6 6 261 c3 144 13 326 22 405 14 131 68 473 80 510 4 14 39 16 279 16 l274 0 25 -145z"/>
                            <path d="M1630 3571 c0 -7 -5 -9 -12 -5 -7 5 -8 3 -3 -5 5 -9 10 -10 18 -2 6 6 8 14 4 18 -4 3 -7 1 -7 -6z"/>
                            <path d="M1608 3523 c5 -21 7 -23 10 -9 2 10 0 22 -6 28 -6 6 -7 0 -4 -19z"/>
                            <path d="M1431 3494 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M1421 3454 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M1525 3259 c-4 -6 -5 -12 -2 -15 2 -3 7 2 10 11 7 17 1 20 -8 4z"/>
                            <path d="M348 3023 c7 -3 16 -2 19 1 4 3 -2 6 -13 5 -11 0 -14 -3 -6 -6z"/>
                            <path d="M295 2989 c-5 -8 -4 -10 3 -5 16 10 15 -6 0 -24 -7 -8 -4 -7 7 2 14 13 16 21 8 29 -8 8 -13 7 -18 -2z"/>
                            <path d="M370 2850 c-8 -5 -10 -10 -5 -10 6 0 17 5 25 10 8 5 11 10 5 10 -5 0 -17 -5 -25 -10z"/>
                            <path d="M164 2838 c-4 -7 -4 -10 1 -6 4 4 15 2 24 -5 14 -11 14 -10 2 6 -16 20 -18 21 -27 5z"/>
                            <path d="M321 2634 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M191 2574 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M213 2545 c0 -8 4 -12 9 -9 5 3 6 10 3 15 -9 13 -12 11 -12 -6z"/>
                            <path d="M221 2454 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M332 2450 c0 -14 2 -19 5 -12 2 6 2 18 0 25 -3 6 -5 1 -5 -13z"/>
                            <path d="M416 1963 c-4 -9 -3 -20 1 -24 4 -4 9 3 9 17 2 28 -1 31 -10 7z"/>
                            <path d="M487 1899 c7 -7 15 -10 18 -7 3 3 -2 9 -12 12 -14 6 -15 5 -6 -5z"/>
                            <path d="M991 2324 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M1010 1906 c0 -2 7 -7 16 -10 8 -3 12 -2 9 4 -6 10 -25 14 -25 6z"/>
                            <path d="M2485 2970 c-3 -6 1 -7 9 -4 18 7 21 14 7 14 -6 0 -13 -4 -16 -10z"/>
                            <path d="M2413 2919 c-2 -23 3 -25 10 -4 4 8 3 16 -1 19 -4 3 -9 -4 -9 -15z"/>
                            <path d="M2405 2879 c-4 -6 -5 -12 -2 -15 2 -3 7 2 10 11 7 17 1 20 -8 4z"/>
                            <path d="M2191 2804 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M2171 2564 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M1971 2034 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M2111 2004 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M2080 1645 c-11 -13 -10 -14 4 -9 9 3 16 10 16 15 0 13 -6 11 -20 -6z"/>
                            <path d="M2030 1610 c-8 -5 -10 -10 -5 -10 6 0 17 5 25 10 8 5 11 10 5 10 -5 0 -17 -5 -25 -10z"/>
                            <path d="M1310 1576 c0 -2 7 -7 16 -10 8 -3 12 -2 9 4 -6 10 -25 14 -25 6z"/>
                            <path d="M1068 1493 c7 -3 16 -2 19 1 4 3 -2 6 -13 5 -11 0 -14 -3 -6 -6z"/>
                            <path d="M920 1481 c0 -6 4 -13 10 -16 6 -3 7 1 4 9 -7 18 -14 21 -14 7z"/>
                            <path d="M1208 1473 c7 -3 16 -2 19 1 4 3 -2 6 -13 5 -11 0 -14 -3 -6 -6z"/>
                            <path d="M851 1284 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M791 934 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M1121 644 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M775 480 c-3 -5 -1 -10 5 -10 6 0 8 -5 4 -12 -4 -7 -3 -8 4 -4 6 4 9 13 5 21 -6 18 -10 19 -18 5z"/>
                            <path d="M1131 404 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M1928 1483 c6 -2 18 -2 25 0 6 3 1 5 -13 5 -14 0 -19 -2 -12 -5z"/>
                            <path d="M2250 1291 c0 -6 4 -13 10 -16 6 -3 7 1 4 9 -7 18 -14 21 -14 7z"/>
                            <path d="M2251 1234 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M2300 460 c-9 -6 -10 -10 -3 -10 6 0 15 5 18 10 8 12 4 12 -15 0z"/>
                            <path d="M1261 724 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M1690 3620 c0 -5 5 -10 11 -10 5 0 7 5 4 10 -3 6 -8 10 -11 10 -2 0 -4 -4 -4 -10z"/>
                            <path d="M1649 3223 c-13 -16 -12 -17 4 -4 16 13 21 21 13 21 -2 0 -10 -8 -17 -17z"/>
                            <path d="M2595 3100 c-2 -3 5 -6 15 -7 11 -1 22 2 24 5 3 4 -4 8 -15 8 -11 0 -22 -3 -24 -6z"/>
                            <path d="M2625 3071 c-3 -5 -2 -12 3 -15 5 -3 9 1 9 9 0 17 -3 19 -12 6z"/>
                            <path d="M179 3008 c-5 -9 -5 -48 -1 -43 6 6 11 45 5 45 -2 0 -4 -1 -4 -2z"/>
                            <path d="M86 2922 c-3 -5 1 -9 9 -9 8 0 12 4 9 9 -3 4 -7 8 -9 8 -2 0 -6 -4 -9 -8z"/>
                            <path d="M2535 2911 c-3 -5 -2 -12 3 -15 5 -3 9 1 9 9 0 17 -3 19 -12 6z"/>
                            <path d="M96 2889 c2 -4 -2 -10 -8 -12 -8 -4 -9 -6 -2 -6 6 -1 17 5 23 12 8 10 7 14 -4 14 -8 0 -12 -4 -9 -8z"/>
                            <path d="M2545 2870 c-3 -5 -2 -18 4 -27 7 -14 9 -12 8 10 -2 30 -3 31 -12 17z"/>
                            <path d="M2456 2761 c-4 -5 -2 -12 3 -15 5 -4 12 -2 15 3 4 5 2 12 -3 15 -5 4 -12 2 -15 -3z"/>
                            <path d="M2416 2722 c-3 -5 1 -9 9 -9 8 0 12 4 9 9 -3 4 -7 8 -9 8 -2 0 -6 -4 -9 -8z"/>
                            <path d="M2340 2625 c0 -5 5 -17 10 -25 5 -8 10 -10 10 -5 0 6 -5 17 -10 25 -5 8 -10 11 -10 5z"/>
                            <path d="M91 2544 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M462 2510 c0 -14 2 -19 5 -12 2 6 2 18 0 25 -3 6 -5 1 -5 -13z"/>
                            <path d="M96 2503 c-6 -14 -5 -15 5 -6 7 7 10 15 7 18 -3 3 -9 -2 -12 -12z"/>
                            <path d="M732 2495 c0 -16 2 -22 5 -12 2 9 2 23 0 30 -3 6 -5 -1 -5 -18z"/>
                            <path d="M2296 2508 c3 -5 10 -6 15 -3 13 9 11 12 -6 12 -8 0 -12 -4 -9 -9z"/>
                            <path d="M751 2434 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M2302 2415 c0 -16 2 -22 5 -12 2 9 2 23 0 30 -3 6 -5 -1 -5 -18z"/>
                            <path d="M190 2210 c-6 -11 -8 -20 -6 -20 3 0 10 9 16 20 6 11 8 20 6 20 -3 0 -10 -9 -16 -20z"/>
                            <path d="M531 2074 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                            <path d="M544 2029 c-3 -6 -2 -15 3 -20 5 -5 9 -1 9 11 0 23 -2 24 -12 9z"/>
                            <path d="M255 1969 c-4 -6 -5 -12 -2 -15 2 -3 7 2 10 11 7 17 1 20 -8 4z"/>
                            <path d="M2222 1725 c0 -16 2 -22 5 -12 2 9 2 23 0 30 -3 6 -5 -1 -5 -18z"/>
                            <path d="M810 1530 c6 -11 13 -20 16 -20 2 0 0 9 -6 20 -6 11 -13 20 -16 20 -2 0 0 -9 6 -20z"/>
                            <path d="M720 1271 c0 -6 4 -13 10 -16 6 -3 7 1 4 9 -7 18 -14 21 -14 7z"/>
                            <path d="M2383 1165 c0 -8 4 -12 9 -9 5 3 6 10 3 15 -9 13 -12 11 -12 -6z"/>
                            <path d="M656 465 c4 -8 0 -23 -7 -33 -12 -15 -12 -16 2 -5 9 7 18 10 22 7 3 -3 3 4 0 15 -3 12 -9 24 -14 27 -5 3 -6 -2 -3 -11z"/>
                            <path d="M726 371 c-5 -8 40 -9 47 -1 3 3 -6 6 -19 6 -13 1 -26 -1 -28 -5z"/>
                        </g>
                    </svg>
                `;
            }

            updateLevel3Display();

            let swipeStartX = 0;

            document.onmousedown = document.ontouchstart = (e) => {
                if (!gameState.canInteract || gameState.isTransitioning) return;
                
                swipeStartX = e.touches ? e.touches[0].clientX : e.clientX;
                
                const moveHandler = (moveE) => {
                    if (!gameState.canInteract || gameState.isTransitioning) return;
                    const currentX = moveE.touches ? moveE.touches[0].clientX : moveE.clientX;
                    const deltaX = currentX - swipeStartX;
                    
                    // Detect right-to-left swipe (deltaX negative)
                    if (deltaX < -60) {
                        swipeCount++;
                        isMirrored = !isMirrored;
                        gameState.progress = Math.min(swipeCount / 10, 1);
                        
                        updateLevel3Display();
                        updateUI();
                        
                        if (gameState.progress >= 0.95 && !gameState.isTransitioning) completeLevel();
                        
                        // Reset for next swipe
                        swipeStartX = currentX;
                    }
                };
                
                const endHandler = () => {
                    document.removeEventListener('mousemove', moveHandler);
                    document.removeEventListener('touchmove', moveHandler);
                    document.removeEventListener('mouseup', endHandler);
                    document.removeEventListener('touchend', endHandler);
                };
                
                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('touchmove', moveHandler);
                document.addEventListener('mouseup', endHandler);
                document.addEventListener('touchend', endHandler);
            };
        }

        // Level 4: Heat up the moka (RUB/DRAG)
        function setupLevel4() {
            elements.svg.innerHTML = `
                <svg viewBox="0 0 300 440" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                    <!-- Full moka pot from provided Moka.svg -->
                    <g transform="translate(-25,440) scale(0.12,-0.12)" fill="#000000" stroke="none">
                        <path d="M1618 3663 c7 -3 16 -2 19 1 4 3 -2 6 -13 5 -11 0 -14 -3 -6 -6z"/>
                        <path d="M1660 3651 c0 -6 4 -12 8 -15 5 -3 9 1 9 9 0 8 -4 15 -9 15 -4 0 -8 -4 -8 -9z"/>
                        <path d="M1310 3640 c-8 -5 -10 -10 -5 -10 6 0 17 5 25 10 8 5 11 10 5 10 -5 0 -17 -5 -25 -10z"/>
                        <path d="M1361 3628 c-45 -24 -47 -38 -17 -165 15 -66 35 -165 45 -221 l18 -102 -76 0 c-42 0 -181 -5 -310 -10 -128 -6 -330 -12 -448 -15 -118 -3 -223 -10 -233 -15 -36 -19 -240 -274 -246 -306 -12 -63 56 -334 187 -748 57 -180 83 -219 155 -231 21 -4 70 -13 109 -20 60 -12 74 -12 99 0 30 16 51 11 39 -8 -5 -8 -2 -8 9 0 8 7 19 9 23 5 5 -4 5 -1 1 6 -4 7 -11 10 -16 7 -17 -11 -20 15 -5 44 18 36 19 67 3 78 -7 4 -38 6 -68 5 -79 -4 -107 9 -130 60 -32 75 -136 725 -124 775 10 39 44 45 215 38 l156 -7 27 -182 c32 -208 88 -512 117 -636 16 -66 20 -116 19 -224 -1 -124 -3 -143 -24 -185 -106 -210 -176 -525 -196 -879 -11 -181 -10 -195 7 -224 37 -64 204 -132 413 -169 150 -27 522 -37 695 -19 283 29 483 90 561 171 l28 29 -1 193 c-2 351 -48 607 -148 825 -19 40 -43 85 -54 101 -18 25 -21 44 -21 148 0 137 9 223 51 538 l31 230 63 100 c100 161 194 302 207 312 7 5 32 15 55 22 24 6 47 20 53 31 39 73 -243 132 -730 151 -145 6 -274 9 -287 6 -19 -3 -22 0 -18 17 2 12 11 59 20 106 9 47 30 138 47 203 l31 119 -27 26 c-25 26 -31 27 -154 30 -88 2 -134 -1 -151 -10z m258 -17 c46 -13 48 -30 12 -173 -18 -73 -40 -178 -49 -234 l-17 -101 -66 1 -67 1 -7 55 c-8 68 -51 284 -71 363 -17 66 -10 83 34 90 44 7 205 6 231 -2z m579 -516 c3 -3 2 -8 -2 -12 -4 -5 -326 -8 -716 -8 -390 0 -712 3 -716 8 -4 4 -5 9 -2 12 3 3 148 8 323 12 290 6 318 5 327 -10 14 -26 168 -25 174 1 5 16 24 17 306 9 166 -4 304 -9 306 -12z m-1678 -104 c0 -54 3 -113 6 -130 l7 -31 -67 0 c-59 0 -70 -3 -93 -26 -25 -25 -25 -29 -19 -103 14 -168 103 -675 127 -723 28 -56 53 -68 136 -68 55 0 73 -3 73 -14 0 -25 -46 -81 -69 -84 -12 -2 -66 4 -119 14 -131 23 -137 30 -201 232 -114 359 -182 622 -183 704 0 45 5 54 77 142 42 52 96 115 119 140 l42 46 82 0 82 0 0 -99z m184 82 c11 -39 38 -244 33 -249 -3 -4 -47 -3 -96 1 l-91 7 0 53 c0 28 -3 86 -6 128 l-7 77 81 0 c68 0 81 -3 86 -17z m179 -13 c42 0 77 -2 77 -5 0 -29 132 -1190 136 -1197 8 -13 -19 -9 -90 12 l-66 21 -15 52 c-23 81 -61 267 -89 437 -25 149 -106 678 -106 691 0 4 17 3 38 -2 20 -5 72 -9 115 -9z m1591 -11 c84 -18 136 -40 136 -57 0 -5 -24 -16 -53 -25 -59 -19 -44 0 -222 -277 -78 -120 -87 -131 -81 -95 3 22 6 141 6 264 l0 224 63 -7 c34 -4 102 -16 151 -27z m-239 -231 c-6 -296 -7 -315 -46 -603 -16 -121 -33 -245 -37 -275 l-7 -55 -65 -21 c-36 -12 -87 -25 -114 -29 l-48 -7 6 79 c32 364 96 947 122 1111 l6 41 62 4 c33 2 75 4 93 5 l32 2 -4 -252z m-994 232 l229 0 0 -621 0 -622 -102 7 c-116 8 -239 24 -247 32 -3 2 -33 258 -67 567 -34 309 -65 582 -68 606 -5 36 -4 42 10 37 9 -3 119 -6 245 -6z m784 -12 c-12 -53 -76 -616 -102 -900 -20 -218 -32 -309 -41 -313 -7 -2 -97 -8 -200 -11 l-187 -7 0 621 0 622 255 3 c140 1 261 3 268 5 8 1 11 -6 7 -20z m-1030 -1187 c120 -45 231 -56 565 -56 334 1 467 14 553 55 l37 18 0 -124 0 -124 -38 -19 c-88 -45 -246 -70 -483 -78 -282 -9 -539 21 -655 78 l-41 20 1 124 c0 69 3 125 6 125 3 0 28 -8 55 -19z m-13 -278 c50 -23 155 -48 252 -59 47 -6 56 -10 51 -23 -13 -31 -45 -218 -65 -366 -31 -242 -40 -369 -41 -600 l-1 -217 -25 7 c-13 3 -66 14 -116 25 -118 25 -172 42 -235 74 -88 44 -92 53 -92 180 0 217 35 480 91 681 31 114 116 328 128 323 3 -2 27 -14 53 -25z m1221 -40 c109 -211 167 -511 167 -874 0 -163 -1 -168 -25 -197 -31 -37 -115 -74 -240 -106 -55 -14 -105 -26 -110 -26 -7 0 -9 28 -7 74 11 204 -31 687 -84 975 -14 73 -23 135 -22 136 2 1 42 10 90 19 48 10 108 29 135 41 26 13 51 24 54 24 4 1 22 -29 42 -66z m-320 -173 c55 -304 77 -544 77 -831 l0 -206 -30 -6 c-129 -26 -600 -33 -704 -10 l-29 6 6 261 c3 144 13 326 22 405 14 131 68 473 80 510 4 14 39 16 279 16 l274 0 25 -145z"/>
                        <path d="M1630 3571 c0 -7 -5 -9 -12 -5 -7 5 -8 3 -3 -5 5 -9 10 -10 18 -2 6 6 8 14 4 18 -4 3 -7 1 -7 -6z"/>
                        <path d="M1608 3523 c5 -21 7 -23 10 -9 2 10 0 22 -6 28 -6 6 -7 0 -4 -19z"/>
                        <path d="M1431 3494 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M1421 3454 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M1525 3259 c-4 -6 -5 -12 -2 -15 2 -3 7 2 10 11 7 17 1 20 -8 4z"/>
                        <path d="M348 3023 c7 -3 16 -2 19 1 4 3 -2 6 -13 5 -11 0 -14 -3 -6 -6z"/>
                        <path d="M295 2989 c-5 -8 -4 -10 3 -5 16 10 15 -6 0 -24 -7 -8 -4 -7 7 2 14 13 16 21 8 29 -8 8 -13 7 -18 -2z"/>
                        <path d="M370 2850 c-8 -5 -10 -10 -5 -10 6 0 17 5 25 10 8 5 11 10 5 10 -5 0 -17 -5 -25 -10z"/>
                        <path d="M164 2838 c-4 -7 -4 -10 1 -6 4 4 15 2 24 -5 14 -11 14 -10 2 6 -16 20 -18 21 -27 5z"/>
                        <path d="M321 2634 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M191 2574 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M213 2545 c0 -8 4 -12 9 -9 5 3 6 10 3 15 -9 13 -12 11 -12 -6z"/>
                        <path d="M221 2454 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M332 2450 c0 -14 2 -19 5 -12 2 6 2 18 0 25 -3 6 -5 1 -5 -13z"/>
                        <path d="M416 1963 c-4 -9 -3 -20 1 -24 4 -4 9 3 9 17 2 28 -1 31 -10 7z"/>
                        <path d="M487 1899 c7 -7 15 -10 18 -7 3 3 -2 9 -12 12 -14 6 -15 5 -6 -5z"/>
                        <path d="M991 2324 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M1010 1906 c0 -2 7 -7 16 -10 8 -3 12 -2 9 4 -6 10 -25 14 -25 6z"/>
                        <path d="M2485 2970 c-3 -6 1 -7 9 -4 18 7 21 14 7 14 -6 0 -13 -4 -16 -10z"/>
                        <path d="M2413 2919 c-2 -23 3 -25 10 -4 4 8 3 16 -1 19 -4 3 -9 -4 -9 -15z"/>
                        <path d="M2405 2879 c-4 -6 -5 -12 -2 -15 2 -3 7 2 10 11 7 17 1 20 -8 4z"/>
                        <path d="M2191 2804 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M2171 2564 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M1971 2034 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M2111 2004 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M2080 1645 c-11 -13 -10 -14 4 -9 9 3 16 10 16 15 0 13 -6 11 -20 -6z"/>
                        <path d="M2030 1610 c-8 -5 -10 -10 -5 -10 6 0 17 5 25 10 8 5 11 10 5 10 -5 0 -17 -5 -25 -10z"/>
                        <path d="M1310 1576 c0 -2 7 -7 16 -10 8 -3 12 -2 9 4 -6 10 -25 14 -25 6z"/>
                        <path d="M1068 1493 c7 -3 16 -2 19 1 4 3 -2 6 -13 5 -11 0 -14 -3 -6 -6z"/>
                        <path d="M920 1481 c0 -6 4 -13 10 -16 6 -3 7 1 4 9 -7 18 -14 21 -14 7z"/>
                        <path d="M1208 1473 c7 -3 16 -2 19 1 4 3 -2 6 -13 5 -11 0 -14 -3 -6 -6z"/>
                        <path d="M851 1284 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M791 934 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M1121 644 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M775 480 c-3 -5 -1 -10 5 -10 6 0 8 -5 4 -12 -4 -7 -3 -8 4 -4 6 4 9 13 5 21 -6 18 -10 19 -18 5z"/>
                        <path d="M1131 404 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M1928 1483 c6 -2 18 -2 25 0 6 3 1 5 -13 5 -14 0 -19 -2 -12 -5z"/>
                        <path d="M2250 1291 c0 -6 4 -13 10 -16 6 -3 7 1 4 9 -7 18 -14 21 -14 7z"/>
                        <path d="M2251 1234 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M2300 460 c-9 -6 -10 -10 -3 -10 6 0 15 5 18 10 8 12 4 12 -15 0z"/>
                        <path d="M1261 724 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M1690 3620 c0 -5 5 -10 11 -10 5 0 7 5 4 10 -3 6 -8 10 -11 10 -2 0 -4 -4 -4 -10z"/>
                        <path d="M1649 3223 c-13 -16 -12 -17 4 -4 16 13 21 21 13 21 -2 0 -10 -8 -17 -17z"/>
                        <path d="M2595 3100 c-2 -3 5 -6 15 -7 11 -1 22 2 24 5 3 4 -4 8 -15 8 -11 0 -22 -3 -24 -6z"/>
                        <path d="M2625 3071 c-3 -5 -2 -12 3 -15 5 -3 9 1 9 9 0 17 -3 19 -12 6z"/>
                        <path d="M179 3008 c-5 -9 -5 -48 -1 -43 6 6 11 45 5 45 -2 0 -4 -1 -4 -2z"/>
                        <path d="M86 2922 c-3 -5 1 -9 9 -9 8 0 12 4 9 9 -3 4 -7 8 -9 8 -2 0 -6 -4 -9 -8z"/>
                        <path d="M2535 2911 c-3 -5 -2 -12 3 -15 5 -3 9 1 9 9 0 17 -3 19 -12 6z"/>
                        <path d="M96 2889 c2 -4 -2 -10 -8 -12 -8 -4 -9 -6 -2 -6 6 -1 17 5 23 12 8 10 7 14 -4 14 -8 0 -12 -4 -9 -8z"/>
                        <path d="M2545 2870 c-3 -5 -2 -18 4 -27 7 -14 9 -12 8 10 -2 30 -3 31 -12 17z"/>
                        <path d="M2456 2761 c-4 -5 -2 -12 3 -15 5 -4 12 -2 15 3 4 5 2 12 -3 15 -5 4 -12 2 -15 -3z"/>
                        <path d="M2416 2722 c-3 -5 1 -9 9 -9 8 0 12 4 9 9 -3 4 -7 8 -9 8 -2 0 -6 -4 -9 -8z"/>
                        <path d="M2340 2625 c0 -5 5 -17 10 -25 5 -8 10 -10 10 -5 0 6 -5 17 -10 25 -5 8 -10 11 -10 5z"/>
                        <path d="M91 2544 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M462 2510 c0 -14 2 -19 5 -12 2 6 2 18 0 25 -3 6 -5 1 -5 -13z"/>
                        <path d="M96 2503 c-6 -14 -5 -15 5 -6 7 7 10 15 7 18 -3 3 -9 -2 -12 -12z"/>
                        <path d="M732 2495 c0 -16 2 -22 5 -12 2 9 2 23 0 30 -3 6 -5 -1 -5 -18z"/>
                        <path d="M2296 2508 c3 -5 10 -6 15 -3 13 9 11 12 -6 12 -8 0 -12 -4 -9 -9z"/>
                        <path d="M751 2434 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M2302 2415 c0 -16 2 -22 5 -12 2 9 2 23 0 30 -3 6 -5 -1 -5 -18z"/>
                        <path d="M190 2210 c-6 -11 -8 -20 -6 -20 3 0 10 9 16 20 6 11 8 20 6 20 -3 0 -10 -9 -16 -20z"/>
                        <path d="M531 2074 c0 -11 3 -14 6 -6 3 7 2 16 -1 19 -3 4 -6 -2 -5 -13z"/>
                        <path d="M544 2029 c-3 -6 -2 -15 3 -20 5 -5 9 -1 9 11 0 23 -2 24 -12 9z"/>
                        <path d="M255 1969 c-4 -6 -5 -12 -2 -15 2 -3 7 2 10 11 7 17 1 20 -8 4z"/>
                        <path d="M2222 1725 c0 -16 2 -22 5 -12 2 9 2 23 0 30 -3 6 -5 -1 -5 -18z"/>
                        <path d="M810 1530 c6 -11 13 -20 16 -20 2 0 0 9 -6 20 -6 11 -13 20 -16 20 -2 0 0 -9 6 -20z"/>
                        <path d="M720 1271 c0 -6 4 -13 10 -16 6 -3 7 1 4 9 -7 18 -14 21 -14 7z"/>
                        <path d="M2383 1165 c0 -8 4 -12 9 -9 5 3 6 10 3 15 -9 13 -12 11 -12 -6z"/>
                        <path d="M656 465 c4 -8 0 -23 -7 -33 -12 -15 -12 -16 2 -5 9 7 18 10 22 7 3 -3 3 4 0 15 -3 12 -9 24 -14 27 -5 3 -6 -2 -3 -11z"/>
                        <path d="M726 371 c-5 -8 40 -9 47 -1 3 3 -6 6 -19 6 -13 1 -26 -1 -28 -5z"/>
                    </g>
                    
                    <!-- Rising coffee rectangle -->
                    <rect id="coffee-rise" x="75" y="220" width="160" height="0" fill="#8B6F47" opacity="0.8"/>
                </svg>
            `;

            let lastX = 0;
            let lastY = 0;

            document.onmousemove = document.ontouchmove = (e) => {
                if (!gameState.canInteract || gameState.isTransitioning) return;
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                const deltaX = Math.abs(clientX - lastX);
                const deltaY = Math.abs(clientY - lastY);
                
                // Only respond to vertical movement (deltaY > deltaX and significant movement)
                if (deltaY > deltaX && deltaY > 2) {
                    gameState.progress = Math.min(gameState.progress + (deltaY / 2500), 1);
                    
                    const maxHeight = 150;
                    const coffeeRect = document.getElementById('coffee-rise');
                    const newHeight = gameState.progress * maxHeight;
                    coffeeRect.setAttribute('height', newHeight);
                    coffeeRect.setAttribute('y', 220 - newHeight);
                    
                    updateUI();
                    
                    if (gameState.progress >= 0.95 && !gameState.isTransitioning) completeLevel();
                }
                
                lastX = clientX;
                lastY = clientY;
            };
        }

        // Level 5: Pour the coffee (CLICK)
        function setupLevel5() {
            elements.svg.innerHTML = `
                <svg viewBox="0 0 200 200" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                    <!-- Espresso cup -->
                    <g id="cup" transform="translate(50,70) scale(2.2)">
                        <path fill="#333" d="M6.8125 7C6.335938 7.089844 5.992188 7.511719 6 8C6 19.152344 11.382813 34.644531 12.59375 38L3 38C2.96875 38 2.9375 38 2.90625 38C2.511719 38.027344 2.167969 38.285156 2.035156 38.65625C1.898438 39.027344 1.996094 39.445313 2.28125 39.71875L4.5625 41.96875C6.496094 43.902344 9.136719 45 11.875 45L33.125 45C35.863281 45 38.503906 43.902344 40.4375 41.96875L42.71875 39.71875C43.015625 39.433594 43.105469 38.992188 42.945313 38.613281C42.789063 38.234375 42.410156 37.992188 42 38L32.40625 38C32.753906 37.023438 33.246094 35.628906 34.09375 32.90625C34.769531 32.777344 37.65625 32.179688 40.71875 30.8125C42.457031 30.035156 44.242188 29.042969 45.625 27.6875C47.007813 26.332031 48 24.5625 48 22.46875C48 18.910156 45.089844 16 41.53125 16C40.300781 16 39.109375 16.34375 38.09375 16.9375C38.640625 13.820313 39 10.746094 39 8C39 7.449219 38.550781 7 38 7L7 7C6.96875 7 6.9375 7 6.90625 7C6.875 7 6.84375 7 6.8125 7 Z M 8.125 9L36.875 9C36.710938 14.652344 35.179688 21.820313 33.53125 27.71875C31.898438 33.5625 30.472656 37.476563 30.28125 38L14.71875 38C14.335938 36.945313 8.453125 20.402344 8.125 9 Z M 41.53125 18C44.011719 18 46 19.988281 46 22.46875C46 23.9375 45.339844 25.148438 44.21875 26.25C43.097656 27.351563 41.507813 28.285156 39.90625 29C37.894531 29.898438 35.976563 30.449219 34.75 30.75C34.996094 29.921875 35.21875 29.148438 35.46875 28.25C36.148438 25.824219 36.828125 23.160156 37.40625 20.46875C37.410156 20.445313 37.433594 20.429688 37.4375 20.40625C38.167969 19.015625 39.800781 18 41.53125 18 Z M 5.40625 40L39.59375 40L39.03125 40.5625C37.472656 42.121094 35.332031 43 33.125 43L11.875 43C9.667969 43 7.527344 42.121094 5.96875 40.5625Z"/>
                    </g>
                    
                    <!-- Rising coffee rectangle -->
                    <rect id="coffee-rise" x="75" y="150" width="50" height="0" fill="#8B6F47" opacity="0.8"/>
                </svg>
            `;

            const handleClick = (e) => {
                if (!gameState.canInteract || gameState.isTransitioning) return;
                
                // Increment progress by 0.10 per click (about 10 clicks to complete)
                gameState.progress = Math.min(gameState.progress + 0.10, 1);
                
                const maxHeight = 60;
                const coffeeRect = document.getElementById('coffee-rise');
                const newHeight = gameState.progress * maxHeight;
                coffeeRect.setAttribute('height', newHeight);
                coffeeRect.setAttribute('y', 150 - newHeight);
                
                updateUI();
                
                if (gameState.progress >= 0.95 && !gameState.isTransitioning) completeLevel();
            };

            let deviceOrientationActive = false;
            let lastTiltX = 0;

            // Tilt detection for mobile
            window.addEventListener('deviceorientation', (e) => {
                if (!gameState.canInteract || gameState.isTransitioning) return;
                
                deviceOrientationActive = true;
                const beta = e.beta || 0; // Rotation around X axis (-180 to 180)
                const gamma = e.gamma || 0; // Rotation around Y axis (-90 to 90)
                
                // Use gamma (left/right tilt) to detect tilt
                const tiltDelta = Math.abs(gamma - lastTiltX);
                lastTiltX = gamma;
                
                if (tiltDelta > 2) {
                    gameState.progress = Math.min(gameState.progress + (tiltDelta / 300), 1);
                    
                    const maxHeight = 60;
                    const coffeeRect = document.getElementById('coffee-rise');
                    const newHeight = gameState.progress * maxHeight;
                    coffeeRect.setAttribute('height', newHeight);
                    coffeeRect.setAttribute('y', 150 - newHeight);
                    
                    updateUI();
                    
                    if (gameState.progress >= 0.95 && !gameState.isTransitioning) completeLevel();
                }
            }, true);

            // Store handler for cleanup
            level5Handlers = {
                click: null,
                mouseDown: null,
                mouseMove: null,
                mouseUp: null
            };
        }

        // Create falling coffee particles
        function createCoffeeParticle() {
            const particle = document.createElement('div');
            particle.style.position = 'absolute';
            particle.style.width = '6px';
            particle.style.height = '6px';
            particle.style.backgroundColor = '#5d4037';
            particle.style.borderRadius = '50%';
            particle.style.pointerEvents = 'none';
            particle.style.left = (Math.random() * 40 + 220) + 'px';
            particle.style.top = '90px';
            particle.style.zIndex = '5';
            elements.gameArea.appendChild(particle);
            
            let y = 130;
            let vx = (Math.random() - 0.5) * 2;
            let vy = Math.random() * 2 + 2;
            
            const animate = setInterval(() => {
                y += vy;
                particle.style.top = y + 'px';
                particle.style.left = (parseInt(particle.style.left) + vx) + 'px';
                
                if (y > 400) {
                    clearInterval(animate);
                    particle.remove();
                }
            }, 30);
        }

        // Complete current level
        function completeLevel() {
            gameState.isTransitioning = true;
            gameState.canInteract = false;
            localStorage.setItem('espresso_level', gameState.currentLevel);
            updateBlur();
            
            document.onmousemove = null;
            document.ontouchmove = null;
            document.onmousedown = null;
            document.ontouchstart = null;
            
            // Clean up Level 5 event listeners
            if (level5Handlers.click) {
                document.removeEventListener('click', level5Handlers.click);
            }
            if (level5Handlers.mouseDown) {
                document.removeEventListener('mousedown', level5Handlers.mouseDown);
                document.removeEventListener('touchstart', level5Handlers.mouseDown);
            }
            if (level5Handlers.mouseMove) {
                document.removeEventListener('mousemove', level5Handlers.mouseMove);
                document.removeEventListener('touchmove', level5Handlers.mouseMove);
            }
            if (level5Handlers.mouseUp) {
                document.removeEventListener('mouseup', level5Handlers.mouseUp);
                document.removeEventListener('touchend', level5Handlers.mouseUp);
            }
            
            setTimeout(() => {
                showTransitionScreen();
            }, 500);
        }

        // Show victory screen
        function showVictoryScreen() {
            elements.victoryScreen.classList.add('show');
            elements.rewardBg.style.filter = 'blur(0px)';
            elements.mainBtn.style.display = 'block';
            elements.resetBtn.style.display = 'block';
            spawnConfetti();
        }

        // Watch YouTube video
        function watchYouTube() {
            window.open('https://www.youtube.com/watch?v=lY5Pt957RhE&feature=youtu.be', '_blank');
        }

        // Spawn confetti
        function spawnConfetti() {
            const confettiPieces = ['üéâ', '‚òï', 'üéÅ', '‚ú®', 'üéä'];
            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.innerText = confettiPieces[Math.floor(Math.random() * confettiPieces.length)];
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }

        // Reset game
        function resetGame() {
            localStorage.clear();
            location.reload();
        }

        // Start the game
        initGame();
    </script>
</body>
</html>
