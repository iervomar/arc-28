<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Qualcosa sta per essere preparato ☕</title>

<style>
  * { box-sizing: border-box; }

  body {
    margin: 0;
    background: #fff6ec;
    font-family: system-ui, -apple-system, sans-serif;
    color: #4a3b2a;
    text-align: center;
    overflow: hidden;
  }

  button {
    border: none;
    border-radius: 999px;
    padding: 14px 26px;
    font-size: 16px;
    background: #d6a75c;
    color: white;
  }

  .screen {
    position: absolute;
    inset: 0;
    display: none;
    padding: 20px;
  }

  .screen.active {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .title {
    font-size: 24px;
    margin-bottom: 24px;
  }

  .reset {
    position: absolute;
    top: 12px;
    right: 12px;
    font-size: 12px;
    background: transparent;
    color: #a78b6d;
  }

  svg {
    width: 220px;
    height: auto;
  }

  .reveal img {
    width: 200px;
    filter: blur(20px);
    transition: filter 1s;
  }
</style>
</head>

<body>

<button class="reset" onclick="resetGame()">Ricomincia</button>

<!-- START -->
<div id="start" class="screen active">
  <div class="title">☕ Qualcosa sta per essere preparato…</div>
  <button onclick="startGame()">Inizia</button>
</div>

<!-- LEVEL 1 -->
<div id="level1" class="screen">
  <svg viewBox="0 0 200 320">

    <!-- BASE -->
    <path d="M50 220 L150 220 L135 300 L65 300 Z"
          fill="#e6e6e6" stroke="#555" stroke-width="2"/>

    <!-- ACQUA -->
    <rect id="water"
          x="70" y="300" width="60" height="0"
          fill="#9bd0f5"/>

    <!-- TUBO -->
    <rect x="95" y="180" width="10" height="80"
          fill="#666"/>

    <!-- FILTRO -->
    <polygon points="70,180 130,180 110,200 90,200"
             fill="#6b4a2b"/>

    <!-- CAMERA SUPERIORE -->
    <path d="M60 40 L140 40 L160 180 L40 180 Z"
          fill="#f4f4f4" stroke="#555" stroke-width="2"/>
  </svg>
</div>

<!-- LEVEL 2 -->
<div id="level2" class="screen">
  <svg viewBox="0 0 200 320">

    <!-- BASE -->
    <path d="M50 220 L150 220 L135 300 L65 300 Z"
          fill="#e6e6e6" stroke="#555" stroke-width="2"/>

    <!-- TUBO -->
    <rect x="95" y="180" width="10" height="80"
          fill="#666"/>

    <!-- FILTRO -->
    <polygon points="70,180 130,180 110,200 90,200"
             fill="#6b4a2b"/>

    <!-- CAFFÈ POLVERE -->
    <rect id="coffeePowder"
          x="75" y="200" width="50" height="0"
          fill="#8b5a2b"/>

    <!-- CAMERA SUPERIORE -->
    <path d="M60 40 L140 40 L160 180 L40 180 Z"
          fill="#f4f4f4" stroke="#555" stroke-width="2"/>
  </svg>
</div>

<!-- REVEAL -->
<div id="reveal" class="screen reveal">
  <img src="nanopresso.png" alt="Nanopresso">
  <div style="margin-top:20px;">Qualcosa prende forma…</div>
  <button style="margin-top:20px;">Continua</button>
</div>

<script>
let level = parseInt(localStorage.getItem("mokaLevel")) || 0;

/* ---------------- UTIL ---------------- */
function show(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function resetGame() {
  localStorage.clear();
  location.href = location.pathname;
}

function startGame() {
  localStorage.setItem("mokaLevel", 1);
  show("level1");
}

/* ---------------- LEVEL 1 – ACQUA ---------------- */
let water = document.getElementById("water");
let waterHeight = 0;
let fillingInterval;

function startWater() {
  fillingInterval = setInterval(() => {
    if (waterHeight < 80) {
      waterHeight += 1.5;
      water.setAttribute("y", 300 - waterHeight);
      water.setAttribute("height", waterHeight);
    }
  }, 16);
}

function stopWater() {
  clearInterval(fillingInterval);

  if (waterHeight > 45 && waterHeight < 65) {
    localStorage.setItem("mokaLevel", 2);
    setTimeout(() => show("level2"), 400);
  }
}

const lvl1 = document.getElementById("level1");
lvl1.addEventListener("touchstart", startWater);
lvl1.addEventListener("touchend", stopWater);

/* ---------------- LEVEL 2 – CAFFÈ ---------------- */
let coffee = document.getElementById("coffeePowder");
let coffeeHeight = 0;
let lastX = null;

function onMove(e) {
  const x = e.touches[0].clientX;
  if (lastX !== null) {
    const delta = Math.abs(x - lastX);
    if (delta > 15 && coffeeHeight < 60) {
      coffeeHeight += 2;
      coffee.setAttribute("y", 200 - coffeeHeight);
      coffee.setAttribute("height", coffeeHeight);
    }
    if (coffeeHeight >= 50) {
      localStorage.setItem("mokaLevel", 3);
      setTimeout(() => show("reveal"), 500);
    }
  }
  lastX = x;
}

function resetMove() {
  lastX = null;
}

const lvl2 = document.getElementById("level2");
lvl2.addEventListener("touchmove", onMove);
lvl2.addEventListener("touchend", resetMove);

/* ---------------- RESUME ---------------- */
if (level === 1) show("level1");
else if (level === 2) show("level2");
else show("start");
</script>

</body>
</html>
